# My muttrc.  Lots of documentation is in muttrc(5).

# Configure native IMAP support.  http://dev.mutt.org/trac/wiki/UseCases/Gmail
# http://wiki.archlinux.org/index.php/Mutt#Native_IMAP_support
set imap_user=lb.waym@gmail.com
set folder=imaps://imap.gmail.com/ # http://dev.mutt.org/trac/wiki/MuttGuide/Folders
set spoolfile=+INBOX
set copy=no # Don't save copies of outgoing messages (Gmail already saves them).
set postponed=+[Gmail]/Drafts # Save drafts remotely.
set imap_check_subscribed # Check all subscribed IMAP folders.

# Configure native SMTP support.
set realname="Lukas Waymann"
set from=lb.waym@gmail.com
set smtp_url=smtps://lb.waym@smtp.gmail.com
set ssl_force_tls

# Default is "us-ascii:iso-8859-1:utf-8".  Really?
# http://wiki.archlinux.org/index.php/Mutt#E-mail_character_encoding
set send_charset="utf-8"

# Empty by default.  This fixes most messages without character encoding indication that I
# get (Mutt assumes "us-ascii" when assumed_charset is empty).
set assumed_charset="cp1252"
# Character set alias: treat iso-8859-1 as an alias for cp1252.
charset-hook ^iso-8859-1$ cp1252
# Background: US-ASCII is basically 8-bit nowadays, so misinterpreting actual ASCII as
# some ASCII-based encoding should be fine.  CP-1252 (or windows-1252) is Microsoft's
# bastardized version of ISO-8859-1 (latin1).  Apparently mislabeling CP-1252 encoded text
# as ISO-8859-1 is so ubiquitous that most programs assume it deliberately and HTML5
# requires that documents advertised as ISO-8859-1 are parsed as CP-1252.  Computers suck.

# Configure GnuPG. From /var/log/pacman.log:
# [2014-03-23 01:32] [PACMAN] Running 'pacman -S mutt'
# [2014-03-23 01:32] [ALPM-SCRIPTLET]
# [2014-03-23 01:32] [ALPM-SCRIPTLET] ==> For GPG support, add the following to your muttrc:
# [2014-03-23 01:32] [ALPM-SCRIPTLET] ==> source /etc/Muttrc.gpg.dist
# [2014-03-23 01:32] [ALPM-SCRIPTLET]
source /etc/Muttrc.gpg.dist
# We need to change some variables from Muttrc.gpg.dist to also include
# "--pinentry-mode loopback" and/or "--encrypt-to 0xC4592C12" (so I can read my own sent
# mail).  Other than that, the commands are the same as in /etc/Muttrc.gpg.dist.
set pgp_decode_command="gpg --status-fd=2 %?p?--passphrase-fd 0 --pinentry-mode loopback? --no-verbose --quiet --batch --output - %f"
set pgp_decrypt_command="gpg --status-fd=2 %?p?--passphrase-fd 0 --pinentry-mode loopback? --no-verbose --quiet --batch --output - %f"
set pgp_sign_command="gpg --no-verbose --batch --quiet --output - %?p?--passphrase-fd 0 --pinentry-mode loopback? --armor --detach-sign --textmode %?a?-u %a? %f"
set pgp_clearsign_command="gpg --no-verbose --batch --quiet --output - %?p?--passphrase-fd 0 --pinentry-mode loopback? --armor --textmode --clearsign %?a?-u %a? %f"
set pgp_encrypt_only_command="pgpewrap gpg --batch --quiet --no-verbose --output - --encrypt --textmode --armor --always-trust --encrypt-to 0xC4592C12 -- -r %r -- %f"
set pgp_encrypt_sign_command="pgpewrap gpg %?p?--passphrase-fd 0 --pinentry-mode loopback? --batch --quiet --no-verbose --textmode --output - --encrypt --sign %?a?-u %a? --armor --always-trust --encrypt-to 0xC4592C12 -- -r %r -- %f"
set crypt_autosign # Always attempt to cryptographically sign outgoing messages.
set pgp_sign_as="C4592C12"

# Get a signature from the message of the day.
set signature="cat /etc/motd|"

set abort_nosubject=no
set abort_unmodified=no

# set alias_file="~/.mutt/aliases"
# source $alias_file

# Cache message headers here.  This takes very little space and makes opening large
# folders much faster.  See http://www.mutt.org/doc/devel/manual.html#header-caching.
set header_cache=~/.mutt/cache/headers/

# Copied from http://gitlab.com/goobook/goobook.
set query_command="goobook query '%s'"
bind editor <Tab> complete-query

# https://wiki.archlinux.org/index.php/Mutt#Viewing_HTML
set mailcap_path="~/.mutt/mailcap"
auto_view text/html
auto_view application/pdf
alternative_order text/plain text/html # Prefer viewing plain text if available.

# source ~/dotfiles/mutt/mutt-colors-solarized/mutt-colors-solarized-dark-256.muttrc
source ~/dotfiles/mutt/vombatidae-mutt/vombatidae.mutt

# Key Bindings {{{1
# Vim-ish {{{2
bind index gg first-entry
bind index G last-entry
bind index,pager  half-up
bind index,pager  half-down
bind pager j next-line
bind pager k previous-line
bind pager g top
bind pager G bottom

# Gmail-esque {{{2
bind index,pager c mail
bind index o display-message
bind pager u exit
bind pager e exit
macro index,pager e "<save-message>=[Gmail]/All%20Mail<enter><enter>" \
   "\"archive\" the current entry (move it to [Gmail]/All Mail)"
bind index x tag-entry
bind pager x tag-message
bind index,pager s flag-message
bind index,pager a group-reply
macro index gi "<change-folder>=INBOX<enter>" "open inbox"
macro index gs "<change-folder>=[Gmail]/Starred<enter>" "open [Gmail]/Starred"
macro index gt "<change-folder>=[Gmail]/Sent%20Mail<enter>" "open [Gmail]/Sent Mail"
macro index gd "<change-folder>=[Gmail]/Drafts<enter>" "open [Gmail]/Drafts"
macro index ga "<change-folder>=[Gmail]/All%20Mail<enter>" "open [Gmail]/All Mail"

# Other (mostly similar to Mutt's defaults) {{{2
bind index O edit
bind pager <Space> half-down
bind pager - half-up
# Mail is only removed from [Gmail]/Inbox (and kept everywhere else, I think) when using
# Mutt's normal delete action with Gmail (called "Archive" in the Gmail web app).  This
# macro seems to work.  TODO: undelete.
macro index,pager d "<save-message>=[Gmail]/Trash<enter><enter>" \
   "\"delete\" the current entry (move it to [Gmail]/Trash)"
macro index,pager gc "<pipe-message>goobook add<return>" \
   "add the sender address to Google Contacts"
# macro attach V "<pipe-entry>cat >~/.mutt/mail.html && chromium ~/.mutt/mail.html<enter>"
# }}}1

# vim: tw=90 sts=-1 sw=3 et nowrap fdm=marker
